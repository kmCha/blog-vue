<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kMchA的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="kmhaoshuai.com">
<meta property="og:type" content="website">
<meta property="og:title" content="kMchA的博客">
<meta property="og:url" content="http://kmhaoshuai.com/index.html">
<meta property="og:site_name" content="kMchA的博客">
<meta property="og:description" content="kmhaoshuai.com">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kMchA的博客">
<meta name="twitter:description" content="kmhaoshuai.com">
  
    <link rel="alternative" href="/atom.xml" title="kMchA的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kMchA的博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">前端小菜鸡</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kmhaoshuai.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-水课哪里跑－UO选课系统自动刷课" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/08/水课哪里跑－UO选课系统自动刷课/" class="article-date">
  <time datetime="2015-12-09T03:19:58.000Z" itemprop="datePublished">2015-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/造福人类/">造福人类</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/08/水课哪里跑－UO选课系统自动刷课/">水课哪里跑－UO－Rabaska自动刷课脚本</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>水课在手，天下我有。水课不仅能帮爱玩的同学们腾出大量时间去玩儿，也能帮学霸同学们节约大量时间来学习自己想学的东西。想必每个人都问学长学姐推荐过本专业的水课，没问题他们会告诉你，但是你上rabaska一看：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/4967862.jpg" alt=""><br>是的，没位置了！</p>
<h1 id="这逗比东西是啥？">这逗比东西是啥？</h1><p>水课哪里跑，是我被uo的选课系统弄抓狂以后写的一个脚本，他可以在选课页面运行然后在后台自动每3s刷新一次，页面下方会记录尝试的次数，如果位置刷出来了，会弹出一个对话框，点击确定之后他会自动帮你把课加入cart，你就只用完成接下来的操作就行了。相比以往的手动刷课方式，你现在只用进入选课页面点一下脚本，然后就可以去做其他事情直到他提示你你才需要去处理，我反正不想一边复习final一边隔几分钟去按一下刷新（ps：<strong>水课哪里跑</strong>是在final复习期间完成的）。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/72474289.jpg" alt=""></p>
<h1 id="这东西咋用？">这东西咋用？</h1><p>首先，你需要做的是在你的浏览器中新建一个书签，也就是收藏网址，你可以新建或者随便收藏一个页面，然后修改他的书签页的网址栏为下面的代码：</p>
<p>有提示音版（课的位置刷出来之后会弹窗提示并且会伴有振奋人心普天同庆般的新闻联播片头曲）：</p>
<pre><code>javascript:!<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">e</span>)</span>{<span class="keyword">var</span> t,n,r,a,o,c,l=[],s=<span class="literal">null</span>;<span class="keyword">for</span>(t=<span class="number">0</span>,n=e.elements.length;n&gt;t;t++)<span class="keyword">switch</span>(s=e.elements[t],s.type){<span class="keyword">case</span><span class="string">"select-one"</span>:<span class="keyword">case</span><span class="string">"select-multiple"</span>:<span class="keyword">if</span>(s.name.length)<span class="keyword">for</span>(r=<span class="number">0</span>,a=s.options.length;a&gt;r;r++)o=s.options[r],o.selected&amp;&amp;(c=<span class="string">""</span>,c=o.hasAttribute?o.hasAttribute(<span class="string">"value"</span>)?o.value:o.text:o.attributes.value.specified?o.value:o.text,l.push(<span class="built_in">encodeURIComponent</span>(s.name)+<span class="string">"="</span>+<span class="built_in">encodeURIComponent</span>(c)));<span class="keyword">break</span>;<span class="keyword">case</span> <span class="keyword">void</span> <span class="number">0</span>:<span class="keyword">case</span><span class="string">"file"</span>:<span class="keyword">case</span><span class="string">"submit"</span>:<span class="keyword">case</span><span class="string">"reset"</span>:<span class="keyword">case</span><span class="string">"button"</span>:<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"radio"</span>:<span class="keyword">case</span><span class="string">"checkbox"</span>:<span class="keyword">if</span>(!s.checked)<span class="keyword">break</span>;<span class="keyword">default</span>:s.name.length&amp;&amp;l.push(<span class="built_in">encodeURIComponent</span>(s.name)+<span class="string">"="</span>+<span class="built_in">encodeURIComponent</span>(s.value))}<span class="keyword">return</span> l.join(<span class="string">"&amp;"</span>)}<span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span>{<span class="keyword">if</span>(<span class="string">"undefined"</span>!=<span class="keyword">typeof</span> XMLHttpRequest)<span class="keyword">return</span> <span class="keyword">new</span> XMLHttpRequest;<span class="keyword">if</span>(<span class="string">"undefined"</span>!=<span class="keyword">typeof</span> ActiveXObject){<span class="keyword">if</span>(<span class="string">"string"</span>!=<span class="keyword">typeof</span> <span class="built_in">arguments</span>.callee.activeXString){<span class="keyword">var</span> e,t,n=[<span class="string">"MSXML2.XMLHttp.6.0"</span>,<span class="string">"MSXML2.XMLHttp.3.0"</span>,<span class="string">"MSXML2.XMLHttp"</span>];<span class="keyword">for</span>(e=<span class="number">0</span>,t=n.length;t&gt;e;e++)<span class="keyword">try</span>{<span class="keyword">var</span> r=<span class="keyword">new</span> ActiveXObject(n[e]);<span class="keyword">return</span> <span class="built_in">arguments</span>.callee.activeXString=n[e],r}<span class="keyword">catch</span>(a){}}<span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="built_in">arguments</span>.callee.activeXString)}<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"No XHR object available."</span>)}<span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span>{r?(a.open(<span class="string">"post"</span>,c.action,!<span class="number">0</span>),a.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>),a.send(e(c))):l.innerHTML=<span class="string">"自动刷课还没开始哦，先选择学期再按一下保存的书签"</span>}<span class="keyword">if</span>(!<span class="built_in">document</span>.querySelector(<span class="string">"#courseInfo"</span>)){<span class="keyword">var</span> r=<span class="built_in">document</span>.querySelector(<span class="string">"#_ctl0__Template_btnCourseGo"</span>),a=t(),o=<span class="number">0</span>,c=<span class="built_in">document</span>.querySelector(<span class="string">"form"</span>),l=<span class="built_in">document</span>.createElement(<span class="string">"p"</span>);l.style.padding=<span class="string">"10px 20px"</span>,l.style.border=<span class="string">"2px dotted #7e7e7e"</span>,l.style.textAlign=<span class="string">"center"</span>,l.style.color=<span class="string">"red"</span>,l.style.fontSize=<span class="string">"2em"</span>,l.id=<span class="string">"courseInfo"</span>,<span class="built_in">document</span>.querySelector(<span class="string">"body"</span>).appendChild(l);<span class="keyword">var</span> s=<span class="built_in">document</span>.createElement(<span class="string">"audio"</span>);s.src=<span class="string">"http://7xoxzw.com1.z0.glb.clouddn.com/successSound.mp3"</span>,s.preload=<span class="string">"auto"</span>;<span class="keyword">var</span> i=<span class="built_in">document</span>.createElement(<span class="string">"audio"</span>);i.src=<span class="string">"http://7xoxzw.com1.z0.glb.clouddn.com/failSound.mp3"</span>,i.preload=<span class="string">"auto"</span>,a.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>{<span class="keyword">if</span>(<span class="number">4</span>==a.readyState){<span class="keyword">if</span>(a.status&gt;=<span class="number">200</span>&amp;&amp;a.status&lt;<span class="number">300</span>||<span class="number">304</span>==a.status){<span class="keyword">if</span>(-<span class="number">1</span>===a.responseText.indexOf(<span class="string">"disabled"</span>))<span class="keyword">if</span>(-<span class="number">1</span>===a.responseText.indexOf(<span class="string">"Your session has expired"</span>)){s.play();<span class="keyword">var</span> t=setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">if</span>(s.currentTime&gt;<span class="number">0</span>){<span class="keyword">var</span> e=confirm(<span class="string">"这个课有位置了，赶紧的！要自动选就按确定"</span>);e===!<span class="number">0</span>?(r.click(),clearInterval(t),clearInterval(u)):(clearInterval(u),clearInterval(t))}},<span class="number">100</span>)}<span class="keyword">else</span>{i.play();<span class="keyword">var</span> n=setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{i.currentTime&gt;<span class="number">0</span>&amp;&amp;(alert(<span class="string">"登陆时间到了，重新登录再来吧"</span>),clearInterval(u),clearInterval(n),l.innerHTML=<span class="string">"水课哪里跑：尝试"</span>+ ++o+<span class="string">"次后，还是没有位置，rabaska让你重新登录了"</span>)},<span class="number">100</span>)}}<span class="keyword">else</span> alert(<span class="string">"服务器错误，刷新试试"</span>),clearInterval(u);l.innerHTML=<span class="string">"水课哪里跑：尝试"</span>+ ++o+<span class="string">"次"</span>}},n();<span class="keyword">var</span> u=setInterval(n,<span class="number">3e3</span>)}}();
</code></pre><p>无提示音版（只有弹窗没有提示音，喜欢清静的同学可以用这个）：</p>
<pre><code>javascript:!<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params">e</span>)</span>{<span class="keyword">var</span> t,n,r,a,o,c,s=[],i=<span class="literal">null</span>;<span class="keyword">for</span>(t=<span class="number">0</span>,n=e.elements.length;n&gt;t;t++)<span class="keyword">switch</span>(i=e.elements[t],i.type){<span class="keyword">case</span><span class="string">"select-one"</span>:<span class="keyword">case</span><span class="string">"select-multiple"</span>:<span class="keyword">if</span>(i.name.length)<span class="keyword">for</span>(r=<span class="number">0</span>,a=i.options.length;a&gt;r;r++)o=i.options[r],o.selected&amp;&amp;(c=<span class="string">""</span>,c=o.hasAttribute?o.hasAttribute(<span class="string">"value"</span>)?o.value:o.text:o.attributes.value.specified?o.value:o.text,s.push(<span class="built_in">encodeURIComponent</span>(i.name)+<span class="string">"="</span>+<span class="built_in">encodeURIComponent</span>(c)));<span class="keyword">break</span>;<span class="keyword">case</span> <span class="keyword">void</span> <span class="number">0</span>:<span class="keyword">case</span><span class="string">"file"</span>:<span class="keyword">case</span><span class="string">"submit"</span>:<span class="keyword">case</span><span class="string">"reset"</span>:<span class="keyword">case</span><span class="string">"button"</span>:<span class="keyword">break</span>;<span class="keyword">case</span><span class="string">"radio"</span>:<span class="keyword">case</span><span class="string">"checkbox"</span>:<span class="keyword">if</span>(!i.checked)<span class="keyword">break</span>;<span class="keyword">default</span>:i.name.length&amp;&amp;s.push(<span class="built_in">encodeURIComponent</span>(i.name)+<span class="string">"="</span>+<span class="built_in">encodeURIComponent</span>(i.value))}<span class="keyword">return</span> s.join(<span class="string">"&amp;"</span>)}<span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span>{<span class="keyword">if</span>(<span class="string">"undefined"</span>!=<span class="keyword">typeof</span> XMLHttpRequest)<span class="keyword">return</span> <span class="keyword">new</span> XMLHttpRequest;<span class="keyword">if</span>(<span class="string">"undefined"</span>!=<span class="keyword">typeof</span> ActiveXObject){<span class="keyword">if</span>(<span class="string">"string"</span>!=<span class="keyword">typeof</span> <span class="built_in">arguments</span>.callee.activeXString){<span class="keyword">var</span> e,t,n=[<span class="string">"MSXML2.XMLHttp.6.0"</span>,<span class="string">"MSXML2.XMLHttp.3.0"</span>,<span class="string">"MSXML2.XMLHttp"</span>];<span class="keyword">for</span>(e=<span class="number">0</span>,t=n.length;t&gt;e;e++)<span class="keyword">try</span>{<span class="keyword">var</span> r=<span class="keyword">new</span> ActiveXObject(n[e]);<span class="keyword">return</span> <span class="built_in">arguments</span>.callee.activeXString=n[e],r}<span class="keyword">catch</span>(a){}}<span class="keyword">return</span> <span class="keyword">new</span> ActiveXObject(<span class="built_in">arguments</span>.callee.activeXString)}<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"No XHR object available."</span>)}<span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span>{r?(a.open(<span class="string">"post"</span>,c.action,!<span class="number">0</span>),a.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"application/x-www-form-urlencoded"</span>),a.send(e(c))):s.innerHTML=<span class="string">"自动刷课还没开始哦，先选择学期再按一下保存的书签"</span>}<span class="keyword">if</span>(!<span class="built_in">document</span>.querySelector(<span class="string">"#courseInfo"</span>)){<span class="keyword">var</span> r=<span class="built_in">document</span>.querySelector(<span class="string">"#_ctl0__Template_btnCourseGo"</span>),a=t(),o=<span class="number">0</span>,c=<span class="built_in">document</span>.querySelector(<span class="string">"form"</span>),s=<span class="built_in">document</span>.createElement(<span class="string">"p"</span>);s.style.padding=<span class="string">"10px 20px"</span>,s.style.border=<span class="string">"2px dotted #7e7e7e"</span>,s.style.textAlign=<span class="string">"center"</span>,s.style.color=<span class="string">"red"</span>,s.style.fontSize=<span class="string">"2em"</span>,s.id=<span class="string">"courseInfo"</span>,<span class="built_in">document</span>.querySelector(<span class="string">"body"</span>).appendChild(s),a.onreadystatechange=<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>{<span class="keyword">if</span>(<span class="number">4</span>==a.readyState){<span class="keyword">if</span>(a.status&gt;=<span class="number">200</span>&amp;&amp;a.status&lt;<span class="number">300</span>||<span class="number">304</span>==a.status){<span class="keyword">if</span>(-<span class="number">1</span>===a.responseText.indexOf(<span class="string">"disabled"</span>))<span class="keyword">if</span>(-<span class="number">1</span>===a.responseText.indexOf(<span class="string">"Your session has expired"</span>)){<span class="keyword">var</span> t=confirm(<span class="string">"这个课有位置了，赶紧的！要自动选就按确定"</span>);t===!<span class="number">0</span>?r.click():clearInterval(i)}<span class="keyword">else</span> alert(<span class="string">"登陆时间到了，重新登录再来吧"</span>),clearInterval(i),s.innerHTML=<span class="string">"水课哪里跑：尝试"</span>+ ++o+<span class="string">"次后，还是没有位置，rabaska让你重新登录了"</span>}<span class="keyword">else</span> alert(<span class="string">"服务器错误，刷新试试"</span>),clearInterval(i);s.innerHTML=<span class="string">"水课哪里跑：尝试"</span>+ ++o+<span class="string">"次"</span>}},n();<span class="keyword">var</span> i=setInterval(n,<span class="number">3e3</span>)}}();
</code></pre><p>就像这样：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/88312649.jpg" alt=""><br>上面是chrome浏览器中的例子，不同浏览器都差不多。添加好以后应该有个叫做<strong>水课哪里跑</strong>书签页在你的书签栏里了，就像这样：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/88868553.jpg" alt=""><br>接下来你就可以登陆uoZone进入rabaska然后选择你要选的课了。通常，你需要进入选课界面，也就是下面这个界面<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/67701937.jpg" alt=""></p>
<h2 id="书签栏问题">书签栏问题</h2><p>那么细心的盆友肯定已经发现了，说好的书签栏呢。对头，坑爹的uo把这个页面的书签栏隐藏了，但是机智的我找出了方法。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/8143797.jpg" alt=""></p>
<ol>
<li>如果你用的是mac，而且浏览器是safari或者chrome（这两个能确定，其他浏览器太懒没测试，没准也能这样），那么你只需要在进入这个页面之前让浏览器全屏，然后再点开这个页面以后就有书签栏了。</li>
<li>如果你用的是windows，而且浏览器是chrome或者chrome内核的浏览器（比如说360极速浏览器），那么你在进入这个页面之后，在他在标题栏点右键，然后点击“显示为标签页”选项，然后书签栏就出来了。</li>
</ol>
<h2 id="下一步">下一步</h2><p>下一步当然就是选学期了，点选下拉列表里的学期选项之后，对于2016 winter，你要想水课的下面seats available不是0的话是不可能的，99.9%你想选的水课在你选择session之后，你会看到下面这个页面：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/87673858.jpg" alt=""><br>是的肯定没位置了，那么这时候，在用这个脚本之前，我们是这样做的：</p>
<ol>
<li>Ctrl+R(mac)/F5(windows)</li>
<li>弹窗问你“确认重新提交表单吗？”</li>
<li>点击确认，然后又看到那个没位置的页面，当然你运气好的话，在你刷了几百次之后可能有位置了</li>
<li>重复1-3步骤</li>
</ol>
<p><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/90166439.jpg" alt=""><br>那么现在有了这个脚本之后，你只用点一下鼠标（我是指用你的鼠标点击一下<strong>水课哪里跑</strong>书签），然后下面就会提示你相关信息</p>
<ol>
<li>当你没选择session就按了<strong>水课哪里跑</strong>之后，页面是这样的：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/49828007.jpg" alt=""></li>
<li>如果你选了session之后按<strong>水课哪里跑</strong>，那你就进入正轨了：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/11365653.jpg" alt=""></li>
</ol>
<p>下面的文字会3秒更新一次，告诉你脚本尝试了多少次提交表单。页面看上去没有刷新，但是实际上已经提交了表单并且已经接收到服务器返回来的数据，在这里你只需要知道it works，具体实现方法我会在之后的技术实现部分解释。</p>
<p>那么课刷出来了之后是什么效果？这里我重新打开一个任何人都不想选的还剩了一堆位置的课来展示一下刷出来位置之后的情况：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/13581140.jpg" alt=""><br>如上图所示，浏览器会弹出来一个优先级最高的对话框告诉你这个课有位置了，然后你就可以愉快的点击确定了。之后这个脚本会帮你做以下事情：</p>
<ol>
<li>勾选这个课</li>
<li>点击Add to cart</li>
</ol>
<p>然后这个页面就自动关闭了，也就是说当你回过神来的时候，点开这个页面之前那个搜索课的页面就被自动定位到你的cart页面了，如下图：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/85262461.jpg" alt=""><br>我能帮你们的就这么多，剩下的几个点鼠标的操作就只有靠你们自己了。<br>还有一种情况就是，登录时间到rabaska规定的时间了，也就是要重新登录才能继续刷课：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-10/5130046.jpg" alt=""><br>点击好之后，页面下方会总结本次水课哪里跑脚本尝试帮你刷了多少次课：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-10/41957075.jpg" alt=""><br>之后就重新登录然后重复之前的步骤直到刷出来就行了。<br><strong>注意:</strong>前面给了两个代码，一种是有提示音的，一种是没有的，可以各取所需。有提示音的在位置刷出来之后和你的登录时间到了需要重新登录的时候都会有提示音。两种方法都会有弹窗。</p>
<h1 id="这东西咋实现的？">这东西咋实现的？</h1><p>前方高能，普通群众可以去愉快的刷课了，对技术感兴趣的盆友可以继续往下看。</p>
<h2 id="背景">背景</h2><p>简单说来，rabaska的选课系统在我们点击session（学期）之后，会发送一个同步请求将表单中的信息（你的加密后的账号信息和你要选的课的信息）传送到服务器端，然后服务器处理之后没问题的话会返回一个html页面，如果该课没位置的话那返回的页面就和发送请求之前的页面是一样的，因此你刷新之后看到的页面是没变化的。但是如果有位置的话，服务器返回的页面中会有非常细微的不同，一个是0 seats available前面的禁止符号会变成一个选择框，另一个是Add to cart可以按了（没位置的时候disabled属性是true）。但是经过我研究，要实现add to cart跟选择框根本没有关系，因为我在没位置时候的页面修改add to cart按钮的disabled属性为false以后，用他触发click()方法之后是能够将它加入cart的，但是因为服务器上确实没位置，因此后续步骤你也不能完成。所以能有个方法在选课页面自动刷新并且能通过服务器返回的数据判断是否有位置了的话是极好的。仔细思考之后发现其实是不难的，不过就是用javascript来操作DOM而已。思路把我引向了<a href="http://tampermonkey.net/" target="_blank" rel="external">油猴脚本</a>，这个实际上就是在各个浏览器中的一个插件，他可以把你写的一个javascript脚本绑定在指定的URL上，这对个人使用当然是极其方便的，但是我是来造福人类的<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/42249496.jpg" alt=""><br>所以不可能让每个人都去下个浏览器扩展才能使用我的脚本吧。因为浏览器是支持javascript:协议的，所以把脚本放在书签页的地址中也可以运行脚本。但是这样做又有个问题，那就是这样做是在页面上运行脚本，不是把脚本绑定在URL上，什么意思呢？如果我用油猴把我的脚本绑定到URL上，不管你咋刷新，只要URL不变，那脚本是会自动执行的。如果我用书签栏，那刷新一次就得重新点击书签重新运行脚本。而恰好rabaska的表单是同步提交的，服务器返回html后页面会立即渲染新的页面，也就相当于刷新了，所以脚本就自动停止了，达不到自动刷新的目的。</p>
<h2 id="实现原理">实现原理</h2><p>为了解决上面的问题，我能想到的办法就是把同步请求换成异步请求，将服务器返回的页面放在回调函数中判断是否有位置用，而不让浏览器渲染新页面，这就是页面为啥看起来没有刷新的原因。<br>具体实现方法就是生成一个XMLHttpRequest对象，用他来将表单的数据每隔3秒提交给服务器一次。如果返回的页面中能找到disabled关键字的话，说明add to cart按钮被禁用了（页面中只有他有这个属性），那么就肯定是没有位置的。当没有disabled关键字的时候，有两种可能，一种是有位置了，一种是session到期了，同样可以简单的通过关键字来判断这两种情况。当最后确定有位置了之后，就调用add to cart对象的click()方法来将课放入你的cart中，剩下的工作就简单了。讲原理不能没有代码，上面给的书签栏中的代码是用gulp压缩之后的js文件，下面给出源代码：</p>
<pre><code><span class="list">(<span class="keyword">function</span><span class="list">()</span> <span class="collection">{
    function serialize<span class="list">(<span class="keyword">form</span>)</span> <span class="collection">{ //序列化表单
        var parts = <span class="collection">[]</span>,
            field = null,
            i,
            len,
            j,
            optLen,
            option,
            optValue;

        for <span class="list">(<span class="keyword">i</span> = <span class="number">0</span>, len = form.elements.length; i &lt; len; i++)</span> <span class="collection">{
            field = form.elements<span class="collection">[i]</span><span class="comment">;</span>

            switch <span class="list">(<span class="keyword">field.type</span>)</span> <span class="collection">{
                case <span class="string">"select-one"</span>:
                case <span class="string">"select-multiple"</span>:

                    if <span class="list">(<span class="keyword">field.name.length</span>)</span> <span class="collection">{
                        for <span class="list">(<span class="keyword">j</span> = <span class="number">0</span>, optLen = field.options.length; j &lt; optLen; j++)</span> <span class="collection">{
                            option = field.options<span class="collection">[j]</span><span class="comment">;</span>
                            if <span class="list">(<span class="keyword">option.selected</span>)</span> <span class="collection">{
                                optValue = <span class="string">""</span><span class="comment">;</span>
                                if <span class="list">(<span class="keyword">option.hasAttribute</span>)</span> <span class="collection">{
                                    optValue = <span class="list">(<span class="keyword">option.hasAttribute</span><span class="list">(<span class="string">"value"</span>)</span> ? option.value : option.text)</span><span class="comment">;</span>
                                }</span> else <span class="collection">{
                                    optValue = <span class="list">(<span class="keyword">option.attributes</span><span class="collection">[<span class="string">"value"</span>]</span>.specified ? option.value : option.text)</span><span class="comment">;</span>
                                }</span>
                                parts.push<span class="list">(<span class="keyword">encodeURIComponent</span><span class="list">(<span class="keyword">field.name</span>)</span> + <span class="string">"="</span> + encodeURIComponent<span class="list">(<span class="keyword">optValue</span>)</span>)</span><span class="comment">;</span>
                            }</span>
                        }</span>
                    }</span>
                    break;

                case undefined: //fieldset
                case <span class="string">"file"</span>: //file input
                case <span class="string">"submit"</span>: //submit button
                case <span class="string">"reset"</span>: //reset button
                case <span class="string">"button"</span>: //custom button
                    break;

                case <span class="string">"radio"</span>: //radio button
                case <span class="string">"checkbox"</span>: //checkbox
                    if <span class="list">(<span class="keyword">!field.checked</span>)</span> <span class="collection">{
                        break;
                    }</span>
                    /* falls through */

                default:
                    //don't include form fields without names
                    if <span class="list">(<span class="keyword">field.name.length</span>)</span> <span class="collection">{
                        parts.push<span class="list">(<span class="keyword">encodeURIComponent</span><span class="list">(<span class="keyword">field.name</span>)</span> + <span class="string">"="</span> + encodeURIComponent<span class="list">(<span class="keyword">field.value</span>)</span>)</span><span class="comment">;</span>
                    }</span>
            }</span>
        }</span>
        return parts.join<span class="list">(<span class="string">"&amp;"</span>)</span><span class="comment">;</span>
    }</span>

    function createXHR<span class="list">()</span> <span class="collection">{ //生成XMLHttpRequest对象
        if <span class="list">(<span class="keyword">typeof</span> XMLHttpRequest != <span class="string">"undefined"</span>)</span> <span class="collection">{
            return new XMLHttpRequest<span class="list">()</span><span class="comment">;</span>
        }</span> else if <span class="list">(<span class="keyword">typeof</span> ActiveXObject != <span class="string">"undefined"</span>)</span> <span class="collection">{
            if <span class="list">(<span class="keyword">typeof</span> arguments.callee.activeXString != <span class="string">"string"</span>)</span> <span class="collection">{
                var versions = <span class="collection">[<span class="string">"MSXML2.XMLHttp.6.0"</span>, <span class="string">"MSXML2.XMLHttp.3.0"</span>,
                        <span class="string">"MSXML2.XMLHttp"</span>
                    ]</span>,
                    i, len;

                for <span class="list">(<span class="keyword">i</span> = <span class="number">0</span>, len = versions.length; i &lt; len; i++)</span> <span class="collection">{
                    try <span class="collection">{
                        var xhr = new ActiveXObject<span class="list">(<span class="keyword">versions</span><span class="collection">[i]</span>)</span><span class="comment">;</span>
                        arguments.callee.activeXString = versions<span class="collection">[i]</span><span class="comment">;</span>
                        return xhr;
                    }</span> catch <span class="list">(<span class="keyword">ex</span>)</span> <span class="collection">{
                        //skip
                    }</span>
                }</span>
            }</span>

            return new ActiveXObject<span class="list">(<span class="keyword">arguments.callee.activeXString</span>)</span><span class="comment">;</span>
        }</span> else <span class="collection">{
            throw new Error<span class="list">(<span class="string">"No XHR object available."</span>)</span><span class="comment">;</span>
        }</span>
    }</span>

    function submitData<span class="list">()</span> <span class="collection">{ //异步提交表单数据
        if <span class="list">(<span class="keyword">addToCart</span>)</span> <span class="collection">{ //选择了学期信息add to cart按钮才会出来，才发送请求
            xhr.open<span class="list">(<span class="string">"post"</span>, form.action, <span class="literal">true</span>)</span><span class="comment">;</span>
            xhr.setRequestHeader<span class="list">(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded"</span>)</span><span class="comment">;</span>
            xhr.send<span class="list">(<span class="keyword">serialize</span><span class="list">(<span class="keyword">form</span>)</span>)</span><span class="comment">;</span>
        }</span> else <span class="collection">{
            p.innerHTML = <span class="string">"自动刷课还没开始哦，先选择学期再按一下保存的书签"</span><span class="comment">;</span>
        }</span>
    }</span>

    if<span class="list">(<span class="keyword">!document.querySelector</span><span class="list">(<span class="string">"#courseInfo"</span>)</span>)</span><span class="collection">{     //检查是否已经点过脚本，不允许重复运行
        var addToCart = document.querySelector<span class="list">(<span class="string">"#_ctl0__Template_btnCourseGo"</span>)</span><span class="comment">;</span>
        var xhr = createXHR<span class="list">()</span><span class="comment">;</span>
        var count = <span class="number">0</span><span class="comment">;</span>
        var form = document.querySelector<span class="list">(<span class="string">"form"</span>)</span><span class="comment">;</span>
        var p = document.createElement<span class="list">(<span class="string">"p"</span>)</span><span class="comment">;</span>
        p.style.padding = <span class="string">"10px 20px"</span><span class="comment">;</span>
        p.style.border = <span class="string">"2px dotted #7e7e7e"</span><span class="comment">;</span>
        p.style.textAlign = <span class="string">"center"</span><span class="comment">;</span>
        p.style.color = <span class="string">"red"</span><span class="comment">;</span>
        p.style.fontSize = <span class="string">"2em"</span><span class="comment">;</span>
        p.id = <span class="string">"courseInfo"</span><span class="comment">;</span>
        document.querySelector<span class="list">(<span class="string">"body"</span>)</span>.appendChild<span class="list">(<span class="keyword">p</span>)</span><span class="comment">;</span>
        var successSound = document.createElement<span class="list">(<span class="string">"audio"</span>)</span><span class="comment">;</span>
        successSound.src = <span class="string">"http://7xoxzw.com1.z0.glb.clouddn.com/successSound.mp3"</span><span class="comment">; //新闻联播(成功提示音)</span>
        successSound.preload = <span class="string">"auto"</span><span class="comment">;</span>
        var failSound = document.createElement<span class="list">(<span class="string">"audio"</span>)</span><span class="comment">;</span>
        failSound.src = <span class="string">"http://7xoxzw.com1.z0.glb.clouddn.com/failSound.mp3"</span><span class="comment">;  //失败提示音</span>
        failSound.preload = <span class="string">"auto"</span><span class="comment">;</span>
        xhr.onreadystatechange = function<span class="list">(<span class="keyword">event</span>)</span> <span class="collection">{
            if <span class="list">(<span class="keyword">xhr.readyState</span> == <span class="number">4</span>)</span> <span class="collection">{
                if <span class="list">(<span class="list">(<span class="keyword">xhr.status</span> &gt;= <span class="number">200</span> &amp;&amp; xhr.status &lt; <span class="number">300</span>)</span> || xhr.status == <span class="number">304</span>)</span> <span class="collection">{
                    if <span class="list">(<span class="keyword">xhr.responseText.indexOf</span><span class="list">(<span class="string">"disabled"</span>)</span> === <span class="number">-1</span>)</span> <span class="collection">{ //响应中没有了disabled字符串，即课有位置了或者session过期了
                        if <span class="list">(<span class="keyword">xhr.responseText.indexOf</span><span class="list">(<span class="string">"Your session has expired"</span>)</span> === <span class="number">-1</span>)</span> <span class="collection">{ //有位置了
                            successSound.play<span class="list">()</span><span class="comment">;</span>
                            var fuckSafari = setInterval<span class="list">(<span class="keyword">function</span><span class="list">()</span><span class="collection">{   //safari中存在先弹窗再播放的bug，这样写能避免
                                if<span class="list">(<span class="keyword">successSound.currentTime</span> &gt; <span class="number">0</span>)</span><span class="collection">{
                                    var conf = confirm<span class="list">(<span class="string">"这个课有位置了，赶紧的！要自动选就按确定"</span>)</span><span class="comment">;</span>
                                    if <span class="list">(<span class="keyword">conf</span> === <span class="literal">true</span>)</span> <span class="collection">{
                                        addToCart.click<span class="list">()</span><span class="comment">; //自动点击add to cart进入cart页面</span>
                                        clearInterval<span class="list">(<span class="keyword">fuckSafari</span>)</span><span class="comment">;</span>
                                        clearInterval<span class="list">(<span class="keyword"><span class="built_in">repeat</span></span>)</span><span class="comment">;</span>
                                    }</span> else <span class="collection">{
                                        clearInterval<span class="list">(<span class="keyword"><span class="built_in">repeat</span></span>)</span><span class="comment">;</span>
                                        clearInterval<span class="list">(<span class="keyword">fuckSafari</span>)</span><span class="comment">;</span>
                                    }</span>
                                }</span>
                            }</span>, <span class="number">100</span>)</span><span class="comment">;</span>
                        }</span> else <span class="collection">{ //session到期
                            failSound.play<span class="list">()</span><span class="comment">;</span>
                            var fuckSafari2 = setInterval<span class="list">(<span class="keyword">function</span><span class="list">()</span><span class="collection">{   //safari中存在先弹窗再播放的bug，这样写能避免
                                if<span class="list">(<span class="keyword">failSound.currentTime</span> &gt; <span class="number">0</span>)</span><span class="collection">{
                                    alert<span class="list">(<span class="string">"登陆时间到了，重新登录再来吧"</span>)</span><span class="comment">;</span>
                                    clearInterval<span class="list">(<span class="keyword"><span class="built_in">repeat</span></span>)</span><span class="comment">;</span>
                                    clearInterval<span class="list">(<span class="keyword">fuckSafari2</span>)</span><span class="comment">;</span>
                                    p.innerHTML = <span class="string">"水课哪里跑：尝试"</span> + <span class="list">(<span class="keyword">++count</span>)</span> + <span class="string">"次后，还是没有位置，rabaska让你重新登录了"</span><span class="comment">;</span>
                                }</span>
                            }</span>, <span class="number">100</span>)</span><span class="comment">;</span>
                        }</span>
                    }</span>
                }</span> else <span class="collection">{
                    alert<span class="list">(<span class="string">"服务器错误，刷新试试"</span>)</span><span class="comment">;</span>
                    clearInterval<span class="list">(<span class="keyword"><span class="built_in">repeat</span></span>)</span><span class="comment">;</span>
                }</span>
                p.innerHTML = <span class="string">"水课哪里跑：尝试"</span> + <span class="list">(<span class="keyword">++count</span>)</span> + <span class="string">"次"</span><span class="comment">;</span>
            }</span>
        }</span><span class="comment">;</span>
        submitData<span class="list">()</span><span class="comment">;</span>
        var repeat = setInterval<span class="list">(<span class="keyword">submitData</span>, <span class="number">3000</span>)</span><span class="comment">;</span>
    }</span>
}</span>)</span><span class="list">()</span><span class="comment">;</span>
</code></pre><p>上面代码中，主题上有3个函数serialize()、createXHR()、submitData()。serialize函数用于在不同浏览器中将表单的数据序列化然后发送给服务器。createXHR用于在不同浏览器中创建XMLHttpRequest对象来发送异步请求。submitData用于提交表单数据。通过给XHR对象绑定事件处理程序来实现成功接收相应后的回调函数和返回失败的错误处理。而生成的p元素被插入到原本的页面中来实现提示功能。</p>
<h2 id="源码地址">源码地址</h2><p>GitHub repo：<a href="https://github.com/kmCha/courserefresh-uo" target="_blank" rel="external">水课哪里跑</a></p>
<h1 id="这东西会不断完善（有时间的话）">这东西会不断完善（有时间的话）</h1><p>所以你们有什么建议意见欢迎给我说。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/96795509.jpg" alt=""><br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/12613772.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://kmhaoshuai.com/2015/12/08/水课哪里跑－UO选课系统自动刷课/" data-id="cii1u7dit0003ve00csom2wmp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/University-of-Ottawa/">University of Ottawa</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/破解/">破解</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/选课/">选课</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-javascript继承" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/07/javascript继承/" class="article-date">
  <time datetime="2015-12-08T04:06:25.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/07/javascript继承/">javascript继承</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天来谈谈这个OOP中重要的话题——继承，读了Nicholas C Zakas所著的《JavaScript高级程序设计（第三版）》之后有感，在这里总结一下，大神们轻点喷。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-8/60513414.jpg" alt=""><br>在javascript中，继承能够通过很多方法来实现，在这里将主要介绍4种继承的方法。</p>
<h2 id="原型链继承(prototype_chain)">原型链继承(prototype chain)</h2><p>javascript继承中，原型链占据了很大的一部分比重。要知道原型链继承的原理首先得知道原型链是啥东西。</p>
<h3 id="原型链">原型链</h3><p>在javascript中，每个构造函数在创建时都会生成一个prototype对象（构造函数的内部属性[[prototype]]指向他的原型对象），而所有自动生成的原型对象中都有一个constructor属性，他的值指向构造函数本身。所以构造函数和他的原型对象之间的关系就像一个环。由构造函数生成的实例中，也会有一个和构造函数一样的内部属性[[prototype]]，指向构造函数的原型对象。因此，这样看来类的实例和构造函数之间啥关系也没有。说了半天那原型链是啥？<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-8/24257355.jpg" alt=""><br>如果我们让一个类（A）的构造函数的原型对象成为另一个类（B）的构造函数的实例，那么这个A的原型对象中就会有个内部属性[[prototype]]指向B的原型对象，并且A的原型对象中包涵了b的所有属性和方法。然而事情并没有完，我们再让B的原型对象成为类C的实例，那么b的原型对象中就会有个内部属性[[prototype]]指向C的原型对象，并且包涵所有C中的属性和方法。这样我们就构成了一个像这样的链条：</p>
<pre><code><span class="constant">A的</span>实例-&gt;<span class="constant">A的</span>原型对象（<span class="constant">B的</span>实例）-&gt;<span class="constant">B的</span>原型对象（<span class="constant">C的</span>实例）-&gt;<span class="constant">C的</span>原型对象
</code></pre><p>这根实例和原型对象的链条就是原型链。由于原型对象是对象，所以一定是原生Object类的一个实例，因此上面的原型链实际上应该是：</p>
<pre><code><span class="constant">A的</span>实例-&gt;<span class="constant">A的</span>原型对象（<span class="constant">B的</span>实例）-&gt;<span class="constant">B的</span>原型对象（<span class="constant">C的</span>实例）-&gt;<span class="constant">C的</span>原型对象（<span class="constant">Object的</span>实例）-&gt;<span class="constant">Object的</span>原型对象
</code></pre><p>有了这样粗黑大硬长的原型链之后，A类生成的实例中就能同时包涵B类、C类和Object类中的所有属性和方法了。<br><strong>但是！</strong>光使用原型链继承的话会带来和光使用原型模式创建对象差不多的问题，如果在超类的原型对象中有引用类型值的属性（比如说数组），那么所有子类的所有实例都会指向同一个引用类型值（比如就那个数组）。举个栗子：</p>
<pre><code><span class="keyword">var</span> Me = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="keyword">this</span>.charac = [<span class="string">"tall"</span>, <span class="string">"rich"</span>, <span class="string">"handsome"</span>];
};
<span class="keyword">var</span> You = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{};
You.prototype = <span class="keyword">new</span> Me();

<span class="keyword">var</span> you1 = <span class="keyword">new</span> You();
you1.charac.push(<span class="string">"ugly"</span>);

<span class="keyword">var</span> you2 = <span class="keyword">new</span> You();
<span class="built_in">console</span>.log(you1.charac);            <span class="comment">// ["tall", "rich", "handsome", "ugly"]</span>
<span class="built_in">console</span>.log(you2.charac);            <span class="comment">// ["tall", "rich", "handsome", "ugly"]</span>
</code></pre><p>所以原型链继承的问题就在子类的原型对象中包涵了父类的所有属性和方法，包括实例属性。那么当父类的一个实例属性是引用类型值（比如数组）的话，那子类的原型对象中的那个引用类型值就会被所有子类的实例引用，因此改变一个实例中的数组就回改变所有子类的实例中的那个数组。为了让每个实例都有自己的个性，必须让引用类型值放在实例属性中，也就是要放在构造函数中。所以又有人想出了下面的方法。</p>
<h2 id="借用构造函数继承(constructor_stealing)">借用构造函数继承(constructor stealing)</h2><p>借用构造函数（constructor stealing）实际上很简单，中心思想就是函数的call（或者apply）方法。原理是在子类的构造函数中调用父类的构造函数的call方法，指定作用域为子类构造函数作用域（把this传进去即可），这样调用子类构造函数就相当于用父类的构造函数创建了包涵父类实例属性和方法的子类实例。同时你还可以在子类的构造函数中加上自定义的实例属性和方法。废话到这看例子：</p>
<pre><code><span class="keyword">var</span> Me = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{
    <span class="keyword">this</span>.name = name;
};

<span class="keyword">var</span> You = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>{
    Me.call(<span class="keyword">this</span>, name);
    <span class="keyword">this</span>.charac = [<span class="string">"tall"</span>, <span class="string">"rich"</span>, <span class="string">"handsome"</span>];
};

<span class="keyword">var</span> you1 = <span class="keyword">new</span> You(<span class="string">"Ao Bama"</span>);
you1.charac.push(<span class="string">"ugly"</span>);

<span class="keyword">var</span> you2 = <span class="keyword">new</span> You(<span class="string">"Jin Zhengen"</span>);

<span class="built_in">console</span>.log(you1.name);    <span class="comment">//"Ao Bama"</span>
<span class="built_in">console</span>.log(you1.charac);  <span class="comment">//["tall", "rich", "handsome", "ugly"]</span>
<span class="built_in">console</span>.log(you2.name);    <span class="comment">//"Jin Zhengen"</span>
<span class="built_in">console</span>.log(you2.charac);  <span class="comment">//["tall", "rich", "handsome"]</span>
</code></pre><p>这样就解决了原型链继承中的引用类型值的问题。<strong>但是！</strong>新的问题总是会冒出来。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/90166439.jpg" alt=""><br>那么借用构造函数的问题又在哪？问题在于函数的复用性。这样光靠构造函数来创建实例，确实能确保实例的个性化，但是同一个类的实例之所以要归入一个类中那不是因为他们肯定在某方面有相同点吗？比如猫都会叫，耗子都会打洞，如果光使用借用构造函数的话，那必须给每个猫实例都生成一个叫的方法，为何不想一种方法让所有猫都能自动继承叫这个方法而不用给每个猫都生成呢？不用我说当然有人提出来改进的方法。</p>
<h2 id="组合继承(combination_inheritance)">组合继承(combination inheritance)</h2><p>其实想要解决单独使用上述两种方法的问题也很简单，把他们拼一起不就完了。于是就有个叫组合继承的方法，在子类构造函数中借用了父类的构造函数来继承实例属性，然后将原型对象设置为父类的实例来继承静态方法，想要添加可以复用的静态方法可以在原型对象中设置，增强了函数的复用性，同时也解决了属性值为引用类型值的问题。组合继承是这么用的：</p>
<pre><code><span class="keyword">var</span> Me = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>{
    <span class="keyword">this</span>.name = name;
};
Me.prototype.papapa = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{
    <span class="comment">//啪啪啪</span>
};

<span class="keyword">var</span> You = <span class="function"><span class="keyword">function</span>(<span class="params">name</span>) </span>{
    Me.call(<span class="keyword">this</span>, name);
    <span class="keyword">this</span>.charac = [<span class="string">"tall"</span>, <span class="string">"rich"</span>, <span class="string">"handsome"</span>];
};
You.prototype = <span class="keyword">new</span> Me();  <span class="comment">// You.prototype.name === undefined</span>

<span class="keyword">var</span> you1 = <span class="keyword">new</span> You(<span class="string">"Ao Bama"</span>);
<span class="keyword">var</span> you2 = <span class="keyword">new</span> You(<span class="string">"Jin Zhengen"</span>);

<span class="built_in">console</span>.log(you1.name);      <span class="comment">//"Ao Bama"</span>
<span class="built_in">console</span>.log(you1.papapa());  <span class="comment">//...</span>
<span class="built_in">console</span>.log(you2.name);      <span class="comment">//"Jin Zhengen"</span>
<span class="built_in">console</span>.log(you2.papapa());  <span class="comment">//...</span>
</code></pre><p>这样在You类的所有实例中都能继承Me中的实例属性和静态方法，既增强了函数复用性，又解决了实例引用同一个引用类型值的问题。好了那么有个俗话就是人无完人，方法也是一个道理，组合继承的问题就是会调用两次父类的构造函数。那问题来了，调用两次又咋的？<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-8/9109857.jpg" alt=""><br>第一次调用发生在子类的原型对象作为父类的实例被创建的时候，生成的子类构造函数的原型对象中会存在父类的未定义的实例属性（如果没传入参数的话就是undefined，见上方You.prototype.name）。第二次在用借用构造函数方法来创建子类实例的时候调用，这时候子类的实例中就会存在和子类构造函数的原型对象中的属性一样的实例属性，也就是说每个子类实例在生成的时候就会带有覆盖了继承他原型对象中属性的实例属性。<br>好嘛那你就说有没有解决上述所有问题的方法嘛。有的有的，下面就来介绍第四种方法，他集上述三个方法的优点于一身，又克服了他们的缺点，可谓是……（不晓得说啥了）</p>
<h2 id="寄生组合继承(parasitic_combination_inheritance)">寄生组合继承(parasitic combination inheritance)</h2><p>这个寄生组合继承相比之前的组合继承多了俩字，寄生。这个词或者说这个方法是由大神Douglas Crockford提出来的，有关寄生式继承这里不说细节，大致思想是通过写一个函数在函数内部用某种方式来返回一个对象。这样就不用像组合继承中一样调用父类的构造函数来生成子类的原型对象了，这样做也就避免了第一次父类构造函数的调用，同时了解决了子类原型对象中会有父类实例属性的问题。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/88476076.jpg" alt=""><br>要实现这个思路，我们先来定义两个函数，第一个函数是：</p>
<pre><code><span class="keyword">var</span> object = <span class="function"><span class="keyword">function</span><span class="params">(dad)</span> </span>{  <span class="comment">//dad为父类原型对象</span>
    <span class="keyword">var</span> Son = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{};
    Son.prototype = dad;
    <span class="keyword">return</span> <span class="keyword">new</span> Son();
};
</code></pre><p>这个函数传入一个父类的原型对象，然后在函数内部创建了一个空的构造函数，并且让构造函数的原型对象等于父类的原型对象，这样就相当于创建了一个没有实例属性的父类，用于解决组合继承中子类原型对象带有父类实例属性的问题。最后返回了这个新构造函数的实例，可以预测这个新实例会被用来当作子类的原型对象。<br>第二个函数是：</p>
<pre><code><span class="keyword">var</span> inheritPrototype = <span class="function"><span class="keyword">function</span><span class="params">(Son, Dad)</span></span>{    <span class="comment">//Son是子类构造函数，Dad是父类构造函数</span>
    <span class="keyword">var</span> prototype = object(Dad.prototype);
    prototype.constructor = Son;                               <span class="comment">//指定自定义原型对象的constructor属性为子类构造函数</span>
    Son.prototype = prototype;                                    <span class="comment">//将子类默认原型对象改为自定义原型对象</span>
};
</code></pre><p>有了这两个函数之后，就可以进行寄生组合继承了：</p>
<pre><code><span class="keyword">var</span> Me = <span class="function"><span class="keyword">function</span><span class="params">(name)</span> </span>{                                <span class="comment">//父类实例属性</span>
    <span class="keyword">this</span>.name = name;
    <span class="keyword">this</span>.charac = [<span class="string">"tall"</span>, <span class="string">"rich"</span>, <span class="string">"handsome"</span>];
};
Me.prototype.papapa = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{            <span class="comment">//父类静态方法</span>
    <span class="comment">//啪啪啪</span>
};

<span class="keyword">var</span> You = <span class="function"><span class="keyword">function</span><span class="params">(name, age)</span> </span>{
    Me.call(<span class="keyword">this</span>, name);                                    <span class="comment">//继承实例属性</span>
    <span class="keyword">this</span>.age = age;                                                <span class="comment">//新增实例属性</span>
};

inheritPrototype(You, Me);                        <span class="comment">//继承静态方法</span>
You.prototype.sayName = <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>{    <span class="comment">//新增静态方法</span>
    alert(<span class="keyword">this</span>.name);
}
</code></pre><p>这样前三种方法的缺点都消失了，可以说是最万能的继承方法。他能去除子类原型对象中多余的父类实例属性，还能保持原型链不变，因此也能用instanceof操作符来判断子类实例所属的类，还能用子类的原型对象的isPrototypeOf()方法来判断子类实例的原型对象，所以<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-9/35413482.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://kmhaoshuai.com/2015/12/07/javascript继承/" data-id="cii1u7dj6000kve00hoif7kyn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Alfred+iterm2+hexo" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/20/Alfred+iterm2+hexo/" class="article-date">
  <time datetime="2015-11-20T19:44:12.000Z" itemprop="datePublished">2015-11-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/工具/">工具</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/20/Alfred+iterm2+hexo/">效率神器Alfred + 命令行神器iterm2实现hexo博客的快速创建、更新、上传</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="关于Alfred">关于Alfred</h2><p>Alfred是一款mac的效率软件，相信不少程序员对他是爱不释手。对普通用户来说他跟mac自带spotlight并没有什么区别，但是他真正牛逼的是他的收费功能自定义workflow。这里不对workflow做详细解释，如果你还没有听说过或者听说过还没用过这个软件，建议先百度一下，有一大把资料能入门-&gt;<a href="http://www.baidu.com/s?wd=Alfred&amp;rsv_spt=1&amp;rsv_iqid=0xa36cff7400007296&amp;issp=1&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;inputT=3345&amp;rsv_t=1aedNNcD9t6rrODXPauSl1RUTu99ApZG6qSEAvtSyJEZkwNVP3HM9JzbCQDN4UK4XmOP&amp;oq=%E9%97%AD%E5%8C%85&amp;rsv_pq=815794f100080c6c&amp;rsv_sug3=33&amp;rsv_sug1=14&amp;rsv_sug2=0&amp;rsv_sug4=3671" target="_blank" rel="external">百度Alfred</a>。</p>
<h2 id="关于iterm2">关于iterm2</h2><p>iterm2是mac上一款能够代替自带terminal的软件，虽然自带的终端功能也比较丰富，但是iterm2用上手了以后会发现有很多能帮助提高效率的地方。同样，本文不对此做过多介绍，<a href="http://www.baidu.com/s?wd=iterm2&amp;rsv_spt=1&amp;rsv_iqid=0xa36cff7400007296&amp;issp=1&amp;f=8&amp;rsv_bp=1&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;inputT=3771&amp;rsv_t=8bb8tRSqKOdnwmKM3ogb7f%2BIHXfTMs5sZNag1Q4uwoRQ2m63Bc%2BRIPCrZJiFliM6c3sR&amp;oq=Alfred&amp;rsv_pq=9733378c00030521&amp;rsv_sug3=45&amp;rsv_sug1=21&amp;rsv_sug2=0&amp;rsv_sug4=4071" target="_blank" rel="external">百度iterm2</a>。<br>另外，配合iterm2的shell建议使用zsh，Github上一个开源项目能帮助你理解和使用-&gt;<a href="https://github.com/robbyrussell/oh-my-zsh" target="_blank" rel="external">oh-my-zsh</a>。</p>
<h3 id="PS：设置Alfred默认打开终端为iterm2">PS：设置Alfred默认打开终端为iterm2</h3><p>Alfred中默认的终端是系统自带的，因此要手动设置将默认的终端变为iterm2。首先打开Alfred的偏好设置（command+,），然后点选Features-&gt;Terminal/Shell，将Application选项改为Custom，<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/2160143.jpg" alt=""><br>接着将下面代码粘贴至上图中的文本域</p>
<pre><code><span class="function_start"><span class="keyword">on</span></span> is_running(app_name)
<span class="keyword">tell</span> <span class="type">application</span> <span class="string">"System Events"</span> <span class="keyword">to</span> (<span class="property">name</span> <span class="keyword">of</span> processes) <span class="keyword">contains</span> app_name
<span class="keyword">end</span> is_running

<span class="comment">-- Please note, if you store the iTerm binary in any other location than the Applications Folder</span>
<span class="comment">-- please ensure you update the two locations below (in the format of : rather than / for folder dividers)</span>
<span class="comment">-- this gets around issues with AppleScript not handling things well if you have two iTerm binaries on your system... which can happen :D</span>

<span class="function_start"><span class="keyword">on</span></span> alfred_script(q)
    <span class="keyword">if</span> is_running(<span class="string">"iTerm"</span>) <span class="keyword">then</span>
        <span class="command">run script</span> <span class="string">"
            on run {q}
                tell application \":Applications:iTerm.app\"
                    activate
                    set myterm to (make new terminal)
                    tell myterm
                        set mysession to (launch session \"Default Session\")
                        tell mysession to write text q
                    end tell
                end tell
            end run
        "</span> <span class="keyword">with</span> parameters {q}
    <span class="keyword">else</span>
        <span class="command">run script</span> <span class="string">"
            on run {q}
                tell application \":Applications:iTerm.app\"
                    activate
                    tell the first terminal
                        tell the last session to write text q
                    end tell
                end tell
            end run
        "</span> <span class="keyword">with</span> parameters {q}
    <span class="keyword">end</span> <span class="keyword">if</span>
<span class="keyword">end</span> alfred_script
</code></pre><p>代码出处：<a href="https://github.com/stuartcryan/custom-iterm-applescripts-for-alfred/blob/master/custom_iterm_script_iterm_2.1.1.applescript" target="_blank" rel="external">custom_iterm_script_iterm_2.1.1</a></p>
<h2 id="回到hexo">回到hexo</h2><h4 id="新建hexo日志">新建hexo日志</h4><p>用hexo搭博客的同学们都知道，如果想新建一个日志，步骤是：</p>
<ol>
<li>打开终端</li>
<li>cd到hexo所在的目录</li>
<li>hexo new (日志名)</li>
<li>用自己的markdown编辑器（我用的sublime text3）打开新建的.mk文件开始编辑<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/90166439.jpg" alt=""></li>
</ol>
<p>那么这时候Alfred workflow就派上用场了，下面介绍怎么用Alfred创建一个快速新建hexo日志的懒人workflow</p>
<p>首先打开Alfred的偏好设置（command+,），然后点击workflow这一栏（收费版本才能使用的功能），你就会看到下面这样的<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/4211599.jpg" alt=""><br>接着点击左下角那个加号（＋），选择Templates-&gt;Essentials-&gt;Keyword to Terminal Command，然后填写workflow名字、作者名字等<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/37792074.jpg" alt=""><br>点击Create以后，在左边workflow列表里就会出现你刚创建的workfolw，点击你刚创建的workflow<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/59938509.jpg" alt=""><br>上面的图片中，左边是设定在Alfred中启动你的workflow所要输入的关键字，右边是执行workflow的终端命令。我们先来设置关键字：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/41572225.jpg" alt=""><br>keyword中填入关键字，因为创建新日志需要给文章取名字，因此还要输入参数，所以勾选了右边的选项。设置好关键字之后我们来设置终端命令：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/16564290.jpg" alt=""><br>这里我用到了如下代码：</p>
<pre><code>j nodejs-hexo
hexo <span class="keyword">n</span> {<span class="keyword">query</span>}
<span class="keyword">cd</span> source/_posts
<span class="keyword">st</span> {<span class="keyword">query</span>}.md
</code></pre><p>第一行的j命令是oh-my-zsh中的一个插件叫做autojump，他会根据你输入的参数来跳到最匹配的目录而不用输入路径。进入hexo目录之后调用hexo new (日志名)来创建新日志，后面的{query}就是我们在Alfred中输入的参数，新建完之后cd到hexo的源文件目录，然后调用编辑器进行编辑，这里st就是oh-my-zsh对于快捷使用sublime text3的插件。因此，经过这样的设置，如果你想创建一篇名字叫“我好帅”的日志，你只用在任意地方用快捷键呼出Alfred，然后输入</p>
<pre><code><span class="title">hexo</span> n 我好帅
</code></pre><p>剩下的事情Alfred就帮你做了，你就只用等着编辑器自动打开然后输入你有多帅了。下面来看看效果：<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/34810900.jpg" alt=""><br>是不是很方便，是不是很high？</p>
<h4 id="更新修改">更新修改</h4><p>有时候你在修改你的某个日志的时候，你并不想每次修改完就提交给Github，而是先在本地服务器测试，这也是正确的做法。那么想要手动更新，步骤是：</p>
<ol>
<li>在编辑器中保存markdown文件</li>
<li>打开终端，cd到hexo所在目录</li>
<li>hexo clear</li>
<li>hexo generate<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/90166439.jpg" alt=""></li>
</ol>
<p>好吧虽然也不是太麻烦，但是为什么不用Alfred和iterm2来简化操作呢。<br>跟新建hexo日志步骤一样，只有终端命令代码不同：</p>
<pre><code><span class="built_in">j</span> nodejs-hexo
hexo clean
hexo generate
</code></pre><p>比新建hexo日志简单了，但原理是相同的，因此当你保存了markdown文件之后，呼出Alfred输入你设置的关键字，他就会帮你更新，你就只用回到浏览器在你的本地服务器的地址上刷新一下，新内容就呈现在你眼前了。<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/1054052.jpg" alt=""></p>
<h4 id="上传博客">上传博客</h4><p>最后一步就是发布博客了，跟前面也没什么不同，只用在终端命令中加一条</p>
<pre><code><span class="title">hexo</span> deploy
</code></pre><p>hexo就回将你的本地静态文件上传给你指定的Github repo了</p>
<h2 id="总结">总结</h2><p>用Alfred对平时的工作效率提升真不是一星半点，本文只介绍了操作hexo博客的方面，这只是能用Alfred做的事情的冰山一角。更多workflow请参考-&gt;<a href="https://github.com/zenorocha/alfred-workflows" target="_blank" rel="external">Alfred workflows</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://kmhaoshuai.com/2015/11/20/Alfred+iterm2+hexo/" data-id="cii1u7dj8000ove0082jy32my" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/">hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/工具/">工具</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/效率/">效率</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-javascript闭包" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/15/javascript闭包/" class="article-date">
  <time datetime="2015-11-15T23:44:12.000Z" itemprop="datePublished">2015-11-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/javascript/">javascript</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/15/javascript闭包/">从原理来看javascript闭包－作用域链</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>本文针对刚接触闭包的新手，也欢迎大家指出任何错误</em><br>相信大家在学习闭包的时候一定看过类似下面这句话“闭包就是内部函数能访问外部函数中的变量，即使外部函数已经返回”。这句话的确能简单粗暴地总结出闭包的精髓，但是却不能透露任何能够帮助理解的细节。抛开多出来的那点（对于现在的javascript引擎来说）性能开销不看，使用闭包的特性缺失能做很多神奇有趣的事情。比如说你想隐藏某些对象的属性从而不会被随意访问或更改，而是只能通过某些接口对外开放，这个接口通常被称为特权方法，是定义在对象内部的可以访问内部属性和方法的方法。而要想内部属性对外不可见，只能通过特权方法来访问或修改内部属性的话，就需要将特权方法放进闭包中，他就能访问包围他的对象构造函数中的私有属性了。<br>说了半天，估计像我一样的新手看见一篇这样的介绍闭包的文章的开篇要开始晕头转向了。因为当时我在搜索闭包是什么东西的时候的心情就是这样的<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-6/89735866.jpg" alt=""><br>所以废话先不多说，下面我就来一步一步谈谈我的理解</p>
<hr>
<h1 id="要理解作用域链就要先知道我之_——_变量对象">要理解作用域链就要先知道我之 —— 变量对象</h1><p>变量对象保存了一个作用域中的所有变量和函数，比如全局作用域的全局变量函数中就保存了在全局作用域中申明的变量和函数。而在一个函数执行的时候，有一个叫做活动对象的充当了变量对象的角色，当中保存了在函数体中申明的变量和函数，通常当函数返回之后就会自动销毁（注意是通常不是总是，因为闭包就用到了他的例外）。</p>
<h1 id="要理解闭包就要先知道我之_——_作用域链">要理解闭包就要先知道我之 —— 作用域链</h1><p>作用域链本质上是一个指向各个不同执行环境（上下文）的变量对象的指针列表。调用函数或者返回一个函数时，该函数会从他的内部属性[[scope]]中创建出一个作用域链，作用域链的最前端指向该函数的活动对象（作为变量对象使用），最后端则指向全局作用域的变量对象，在中间的指向包含该函数的函数（如果有的话）的作用域中的活动对象。</p>
<h1 id="回到闭包">回到闭包</h1><p>知道了作用域链的原理，可以帮助理解闭包是怎么回事。当一个函数被调用的时候或者内部匿名函数被外部函数返回的时候，就会产生一个作用域链。拿内部匿名函数被返回的例子来说，假设内部匿名函数返回后被传递给了一个变量，他的作用域链包涵了他自己的活动对象、包围函数（外部函数）的活动对象和全局变量对象。一般情况下当函数执行完毕的时候他的执行环境中的作用域链和活动对象都会被销毁，前提是在没有其他的作用域链引用他的活动对象的情况下。而闭包就不是在这个前提下的，内部匿名函数的作用域链引用了外部包围函数的活动对象，因此当外部包围函数返回后，他的作用域链会被销毁，但是他的活动对象因为内部函数的作用域链的引用而依旧坚挺，所以才会产生闭包这种神奇的现象。只要那个指向返回的匿名函数的变量不被设置为null（手动让垃圾回收装置回收），那么那个返回他的外部函数的活动对象就一直存在于他的作用域链中，因此内部函数也就一直能访问外部函数中的变量了。<br>这正是闭包的强大之处，也是容易犯错的地方。利用这个特性，可以在外部函数返回之后继续访问或修改外部函数的变量，这就是在开篇介绍的用特权方法访问私有属性的本质原理。利用闭包强大的特性还能够实现很多有趣而且强大的功能，很多javascript高级用法都用到了闭包的特性<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-6/30952458.jpg" alt=""></p>
<h2 id="新手容易踩的坑">新手容易踩的坑</h2><p>为了更好的理解，我这里就举一个网上一抓一大把的例子然后按照上面讲的原理来分析一下</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">woShiShuaiGe</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();
    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {
        arr[i] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
            <span class="keyword">return</span> i;
        };
    }
    <span class="keyword">return</span> arr;
}
<span class="keyword">var</span> globalArr = woShiShuaiGe();
</code></pre><p>上面的函数中，woShiShuaiGe函数调用后会反悔一个由函数组成的数组，数组中每个函数调用之后会返回一个索引值。刚接触闭包这个概念同学（比如说我当时）就觉得那这每个函数肯定都会返回自己的索引值啊，像下面那样</p>
<pre><code>globalArr[<span class="link_label">0</span>](<span class="link_url"></span>);      //10
globalArr[<span class="link_label">5</span>](<span class="link_url"></span>);      //10
</code></pre><p>实际上数组中的所有函数调用后都返回10，也就是woShiShuaiGe执行完毕后的i变量的值。再回头看看woShiShuaiGe函数，for中定义了i变量并且赋值为0。在javascript中只有函数作用域一说，因此i变量实际上是存在于woShiShuaiGe函数的活动对象中的。这时候，作为闭包的arr[i]函数当然就能访问他的包围函数（也就是woShiShuaiGe函数）中的变量，而这个例子中他就返回了i。<br>下面我根据前面讲的原理来分析一下上面的过程。首先woShiShuaiGe函数申明之后被调用，然后返回的数组被赋值给了一个变量，而且返回的数组中保存着有woShiShuaiGe的闭包，所以本应该在woShiShuaiGe函数执行完毕后自动销毁的活动对象不会被销毁（因为globalArr变量中的函数还保存有对woShiShuaiGe函数中变量的引用）。既然woShiShuaiGe的活动对象没有被销毁，那么现在闭包要访问其中的变量那当然就是函数执行后的变量值了。因为woShiShuaiGe函数调用后i＝10，所以globalArr中的函数调用后都返回10。<br>那么造成以上问题的原因，相信大家如果看过相关闭包的文章的话，应该看到过类似下面这句话</p>
<blockquote>
<p>闭包中引用的值是外部函数中的最终值，而不是闭包函数被创建的时候的值</p>
</blockquote>
<p>那既然话是这么说的，那我们是不是让闭包引用创建他的时候的值就行了？ exactly！<br><img src="http://7xoxzw.com1.z0.glb.clouddn.com/15-12-7/99274798.jpg" alt=""><br>话不多说先看例子:</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">woShiShuaiGe</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>();
    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {
        arr[i] = <span class="function"><span class="keyword">function</span>(<span class="params">num</span>) </span>{
            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
                <span class="keyword">return</span> num;
            };
        }(i);
    }
    <span class="keyword">return</span> arr;
}
<span class="keyword">var</span> globalArr = woShiShuaiGe();
</code></pre><p>上面的改进方法中，我们将一个立即执行的匿名函数的返回的函数赋值给了arr[i]（注意最后的(i)）。我们将此时woShiShuaiGe函数的活动对象中的i变量传递给了那个立即执行的匿名函数，因为那个函数悲催地连世界都没好好的看一眼就被立即执行了，因此传给他的i的值正是他创建（刚创建就被执行了）的时候的i的值。这时候i的值进入了外部匿名函数并且被赋值给了外部匿名函数活动对象中的num变量，而返回的内部匿名函数因为是闭包所以能够访问外部匿名函数中的变量值，因此他返回了num。最终woShiShuaiGe函数返回的数组中的每个函数都有自己的num值，而自己那个num值都是自己在被创建的时候的i值，所以这样就能正确返回索引值了。</p>
<pre><code>globalArr[<span class="link_label">0</span>](<span class="link_url"></span>);      //0
globalArr[<span class="link_label">5</span>](<span class="link_url"></span>);      //5
</code></pre><h1 id="总结">总结</h1><p>以上就是我对闭包的理解和分析，希望能对刚接触这个概念的新手们有点帮助，因为我觉得真正搞懂了原理才能更好的应用。本文举的一个例子仅仅是为了解释闭包的原理，除此之外闭包还有很多的用法。在很多高级概念中闭包都是最基础的内容，因此搞懂闭包还是很有必要的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://kmhaoshuai.com/2015/11/15/javascript闭包/" data-id="cii1u7dj3000eve001352ness" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/前端/">前端</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/造福人类/">造福人类</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/University-of-Ottawa/">University of Ottawa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/工具/">工具</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/效率/">效率</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/破解/">破解</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/选课/">选课</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/University-of-Ottawa/" style="font-size: 10px;">University of Ottawa</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/前端/" style="font-size: 15px;">前端</a> <a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/效率/" style="font-size: 10px;">效率</a> <a href="/tags/破解/" style="font-size: 10px;">破解</a> <a href="/tags/选课/" style="font-size: 10px;">选课</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/12/08/水课哪里跑－UO选课系统自动刷课/">水课哪里跑－UO－Rabaska自动刷课脚本</a>
          </li>
        
          <li>
            <a href="/2015/12/07/javascript继承/">javascript继承</a>
          </li>
        
          <li>
            <a href="/2015/11/20/Alfred+iterm2+hexo/">效率神器Alfred + 命令行神器iterm2实现hexo博客的快速创建、更新、上传</a>
          </li>
        
          <li>
            <a href="/2015/11/15/javascript闭包/">从原理来看javascript闭包－作用域链</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 kMchA<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>